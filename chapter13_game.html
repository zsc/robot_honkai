<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>第十章 - 凯瑟琳的试炼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: "微软雅黑", Arial, sans-serif;
            background: #000;
            overflow: hidden;
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        /* 游戏画布 - 优化背景 */
        #gameCanvas {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, 
                #0a0e27 0%, 
                #151b3d 30%, 
                #1e2654 60%, 
                #2a3670 85%, 
                #384490 100%);
        }

        /* 虚拟训练室网格效果 - 更细腻 */
        .grid-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(0deg, rgba(0, 206, 209, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 206, 209, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            animation: gridScroll 20s linear infinite;
        }

        @keyframes gridScroll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(40px, 40px); }
        }
        
        /* 地面效果 */
        .ground-line {
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: 100px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 206, 209, 0.5), 
                rgba(0, 206, 209, 0.8),
                rgba(0, 206, 209, 0.5),
                transparent);
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.5);
        }

        /* 派蒙助手 - 调整位置避免遮挡 */
        .paimon {
            position: fixed;
            top: 120px;
            right: 30px;
            width: 60px;
            height: 60px;
            z-index: 100;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 182, 193, 0.5));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(-5deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        /* 派蒙对话框 - 优化位置和样式 */
        .paimon-dialog {
            position: fixed;
            top: 120px;
            right: 100px;
            background: linear-gradient(135deg, rgba(20, 20, 40, 0.95), rgba(40, 20, 60, 0.95));
            border: 2px solid rgba(255, 182, 193, 0.8);
            border-radius: 15px;
            padding: 15px 20px;
            max-width: 280px;
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
            z-index: 101;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
        }

        .paimon-dialog.active {
            opacity: 1;
            transform: scale(1);
        }

        .paimon-dialog::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid rgba(255, 182, 193, 0.8);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        /* 教学提示 - 移到顶部避免遮挡 */
        .tutorial-hint {
            position: fixed;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(0, 30, 60, 0.95), rgba(0, 60, 90, 0.95));
            border: 2px solid rgba(0, 206, 209, 0.8);
            border-radius: 10px;
            padding: 15px 35px;
            color: #00CED1;
            font-size: 16px;
            text-align: center;
            z-index: 90;
            animation: pulse 2s ease-in-out infinite;
            box-shadow: 0 5px 25px rgba(0, 206, 209, 0.3);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 206, 209, 0.5); }
            50% { box-shadow: 0 0 40px rgba(0, 206, 209, 0.8); }
        }

        .key-hint {
            display: inline-block;
            background: rgba(155, 89, 182, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            margin: 0 5px;
            font-weight: bold;
            color: #fff;
        }

        /* 任务目标 - 优化样式 */
        .mission-objective {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(40, 30, 0, 0.9), rgba(60, 45, 0, 0.9));
            border: 2px solid rgba(255, 215, 0, 0.6);
            border-radius: 10px;
            padding: 12px 35px;
            color: #FFD700;
            font-size: 18px;
            font-weight: bold;
            z-index: 80;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.3);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* 进度条 - 优化样式 */
        .progress-bar {
            position: fixed;
            top: 65px;
            left: 50%;
            transform: translateX(-50%);
            width: 350px;
            height: 24px;
            background: linear-gradient(90deg, rgba(0, 20, 40, 0.8), rgba(0, 40, 60, 0.8));
            border: 2px solid rgba(0, 206, 209, 0.6);
            border-radius: 12px;
            overflow: hidden;
            z-index: 80;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.5), 0 2px 15px rgba(0, 206, 209, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00CED1, #00FF7F);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* 玩家机甲 - 优化大小和位置 */
        .player-mecha {
            position: absolute;
            width: 100px;
            height: 120px;
            bottom: 102px;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.1s ease;
            filter: drop-shadow(0 0 15px rgba(255, 105, 180, 0.5));
            z-index: 50;
        }

        /* 训练假人 */
        .training-dummy {
            position: absolute;
            width: 60px;
            height: 80px;
            bottom: 100px;
        }

        /* 全息靶标 */
        .hologram-target {
            position: absolute;
            width: 50px;
            height: 50px;
            animation: hologramPulse 2s ease-in-out infinite;
        }

        @keyframes hologramPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
        }

        /* 子弹 */
        .bullet {
            position: absolute;
            width: 20px;
            height: 5px;
            background: linear-gradient(90deg, #FFD700, #FFA500);
            border-radius: 50%;
            box-shadow: 0 0 10px #FFD700;
        }

        /* 元素效果 */
        .element-effect {
            position: absolute;
            width: 100px;
            height: 100px;
            pointer-events: none;
            animation: elementExpand 0.5s ease-out forwards;
        }

        @keyframes elementExpand {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* 伤害数字 */
        .damage-number {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            pointer-events: none;
            animation: damageFloat 1s ease-out forwards;
        }

        @keyframes damageFloat {
            0% { 
                transform: translateY(0) scale(1); 
                opacity: 1; 
            }
            100% { 
                transform: translateY(-50px) scale(0.5); 
                opacity: 0; 
            }
        }

        .damage-normal { color: #FFD700; }
        .damage-critical { color: #FF6347; font-size: 32px; }
        .damage-elemental { color: #9B59B6; }

        /* 控制按钮（移动端） */
        .mobile-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: none;
            z-index: 100;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(0, 206, 209, 0.5);
            border-radius: 50%;
            color: #00CED1;
            font-size: 20px;
            margin: 5px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .control-btn:active {
            background: rgba(0, 206, 209, 0.3);
        }

        /* 成就提示 - 优化样式 */
        .achievement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.95), rgba(255, 140, 0, 0.95));
            border: 3px solid #FFD700;
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            z-index: 200;
            animation: achievementPop 0.5s ease-out forwards;
            box-shadow: 0 10px 50px rgba(255, 215, 0, 0.5);
        }

        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(0deg); }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(5deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }

        .achievement h2 {
            color: #8B4513;
            margin-bottom: 10px;
        }

        .achievement p {
            color: #654321;
        }

        /* 凯瑟琳NPC - 调整位置 */
        .katherine {
            position: absolute;
            width: 80px;
            height: 120px;
            bottom: 102px;
            left: 50px;
            z-index: 45;
            filter: drop-shadow(0 0 10px rgba(155, 89, 182, 0.5));
        }

        /* 元素教学区域 */
        .element-tutorial-zone {
            position: absolute;
            width: 200px;
            height: 200px;
            border: 2px dashed rgba(155, 89, 182, 0.5);
            border-radius: 10px;
            background: rgba(155, 89, 182, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #9B59B6;
        }

        /* HUD覆盖层 */
        .hud-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 70;
        }

        /* 技能冷却指示器 - 调整到右下角 */
        .skill-cooldown-indicator {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            z-index: 75;
        }

        .skill-icon {
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(0, 206, 209, 0.5);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .skill-icon.on-cooldown::after {
            content: attr(data-cooldown);
            position: absolute;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #FF6347;
            border-radius: 8px;
        }

        /* 教学阶段标题 */
        .stage-title {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            color: #00CED1;
            text-shadow: 0 0 30px rgba(0, 206, 209, 0.8);
            opacity: 0;
            animation: stageIntro 3s ease-out;
            pointer-events: none;
            z-index: 150;
        }

        @keyframes stageIntro {
            0% { opacity: 0; transform: translate(-50%, -30%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }
            80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -70%) scale(0.8); }
        }
    </style>
</head>
<body>
    <!-- 游戏画布 -->
    <div id="gameCanvas">
        <!-- 网格效果 -->
        <div class="grid-overlay"></div>
        
        <!-- 地面线 -->
        <div class="ground-line"></div>

        <!-- 凯瑟琳NPC -->
        <div class="katherine">
            <svg width="80" height="120" viewBox="0 0 80 120">
                <!-- 身体 -->
                <rect x="20" y="50" width="40" height="50" fill="#4B0082" stroke="#9B59B6" stroke-width="2"/>
                <!-- 头部 -->
                <circle cx="40" cy="30" r="18" fill="#FDBCB4" stroke="#9B59B6" stroke-width="1"/>
                <!-- AR眼镜 -->
                <rect x="25" y="27" width="30" height="10" fill="rgba(0, 206, 209, 0.7)" stroke="#00CED1" stroke-width="1"/>
                <!-- 冒险者协会标志 -->
                <circle cx="40" cy="75" r="10" fill="none" stroke="#FFD700" stroke-width="2"/>
                <path d="M40,65 L46,75 L40,85 L34,75 Z" fill="#FFD700"/>
            </svg>
        </div>

        <!-- 派蒙助手 -->
        <div class="paimon">
            <svg width="60" height="60" viewBox="0 0 60 60">
                <!-- 派蒙身体 -->
                <ellipse cx="30" cy="35" rx="15" ry="18" fill="#FFF5EE" stroke="#FFB6C1" stroke-width="2"/>
                <!-- 派蒙头部 -->
                <circle cx="30" cy="20" r="12" fill="#FFF5EE" stroke="#FFB6C1" stroke-width="2"/>
                <!-- 星星头饰 -->
                <path d="M30,6 L32,10 L36,10 L33,13 L34,17 L30,15 L26,17 L27,13 L24,10 L28,10 Z" 
                      fill="#FFD700" stroke="#FFA500" stroke-width="1"/>
                <!-- 眼睛 -->
                <circle cx="27" cy="20" r="1.5" fill="#000"/>
                <circle cx="33" cy="20" r="1.5" fill="#000"/>
                <!-- 嘴巴 -->
                <path d="M27,23 Q30,25 33,23" stroke="#FFB6C1" stroke-width="1.5" fill="none"/>
                <!-- 小翅膀 -->
                <ellipse cx="15" cy="35" rx="6" ry="12" fill="#FFF" stroke="#FFB6C1" stroke-width="1" transform="rotate(-20 15 35)"/>
                <ellipse cx="45" cy="35" rx="6" ry="12" fill="#FFF" stroke="#FFB6C1" stroke-width="1" transform="rotate(20 45 35)"/>
            </svg>
        </div>

        <!-- 派蒙对话框 -->
        <div class="paimon-dialog" id="paimonDialog">
            <span id="paimonText">欢迎来到冒险者协会的虚拟训练室！</span>
        </div>

        <!-- 任务目标 -->
        <div class="mission-objective" id="missionObjective">
            任务：学习基础移动
        </div>

        <!-- 进度条 -->
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- 教学提示 -->
        <div class="tutorial-hint" id="tutorialHint">
            按 <span class="key-hint">A</span> 和 <span class="key-hint">D</span> 键左右移动
        </div>

        <!-- 玩家机甲 -->
        <div class="player-mecha" id="playerMecha">
            <svg width="100" height="120" viewBox="0 0 100 120">
                <!-- 使用简化的胡桃机甲设计 -->
                <g transform="translate(50, 60)">
                    <!-- 主躯干 -->
                    <path d="M 0,-40 L 15,-37 L 20,-20 L 22,8 L 18,25 L 10,38 L 0,42 
                             L -10,38 L -18,25 L -22,8 L -20,-20 L -15,-37 Z" 
                          fill="url(#mechaGradient)" stroke="#8B0000" stroke-width="2"/>
                    
                    <!-- 头部 -->
                    <ellipse cx="0" cy="-30" rx="12" ry="10" fill="#2C1810" stroke="#8B0000" stroke-width="1.5"/>
                    
                    <!-- 观测窗 -->
                    <rect x="-8" y="-32" width="16" height="5" fill="#FF1493" opacity="0.9">
                        <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/>
                    </rect>
                    
                    <!-- 核心 -->
                    <circle cx="0" cy="0" r="8" fill="none" stroke="#FF69B4" stroke-width="2.5" opacity="0.9">
                        <animate attributeName="r" values="7;10;7" dur="1.5s" repeatCount="indefinite"/>
                    </circle>
                    <circle cx="0" cy="0" r="4" fill="#FF1493" opacity="0.7">
                        <animate attributeName="opacity" values="0.5;1;0.5" dur="1.5s" repeatCount="indefinite"/>
                    </circle>
                    
                    <!-- 左臂 -->
                    <rect x="-32" y="-12" width="10" height="30" fill="#1C0F08" stroke="#8B0000" stroke-width="1"/>
                    <!-- 右臂 -->
                    <rect x="22" y="-12" width="10" height="30" fill="#1C0F08" stroke="#8B0000" stroke-width="1"/>
                    
                    <!-- 左腿 -->
                    <rect x="-12" y="25" width="10" height="25" fill="#1C0F08" stroke="#8B0000" stroke-width="1"/>
                    <!-- 右腿 -->
                    <rect x="2" y="25" width="10" height="25" fill="#1C0F08" stroke="#8B0000" stroke-width="1"/>
                </g>
                
                <!-- 机甲渐变定义 -->
                <defs>
                    <linearGradient id="mechaGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#2C1810"/>
                        <stop offset="50%" stop-color="#1C0F08"/>
                        <stop offset="100%" stop-color="#0F0704"/>
                    </linearGradient>
                </defs>
            </svg>
        </div>

        <!-- 技能冷却指示器 -->
        <div class="skill-cooldown-indicator">
            <div class="skill-icon" id="skillE">
                <span style="color: #9B59B6; font-size: 20px;">E</span>
            </div>
            <div class="skill-icon" id="skillQ">
                <span style="color: #FFD700; font-size: 20px;">Q</span>
            </div>
        </div>
    </div>

    <!-- 移动端控制 -->
    <div class="mobile-controls" id="mobileControls">
        <button class="control-btn" onclick="moveLeft()">←</button>
        <button class="control-btn" onclick="jump()">↑</button>
        <button class="control-btn" onclick="moveRight()">→</button>
        <button class="control-btn" onclick="shoot()">射</button>
    </div>

    <script>
        // 游戏状态
        const gameState = {
            currentStage: 0,
            playerX: 50, // 百分比位置
            playerY: 80,
            isMoving: false,
            canShoot: true,
            score: 0,
            tutorialProgress: 0,
            tutorialStages: [
                { name: "移动教学", objective: "学习基础移动", hint: "按 A/D 键左右移动" },
                { name: "跳跃教学", objective: "学习跳跃", hint: "按 空格键 跳跃" },
                { name: "射击教学", objective: "击中训练假人", hint: "按 鼠标左键 射击" },
                { name: "元素战技", objective: "使用元素战技", hint: "按 E 键释放火元素战技" },
                { name: "元素爆发", objective: "使用元素爆发", hint: "按 Q 键释放大招" },
                { name: "元素反应", objective: "触发蒸发反应", hint: "先施加水元素，再使用火元素" },
                { name: "实战测试", objective: "击败所有训练假人", hint: "综合运用所学技能" }
            ],
            enemies: [],
            bullets: [],
            effects: []
        };

        // 派蒙语音库
        const paimonLines = {
            welcome: [
                "欢迎来到虚拟训练室！我是派蒙，你的应急...啊不，是你的训练助手！",
                "哇！新的驾驶员！让派蒙来教你怎么操作机甲吧！",
                "准备好了吗？训练马上开始咯！"
            ],
            movement: [
                "试试用A和D键左右移动吧！",
                "很好！你学得真快！",
                "移动是战斗的基础哦～"
            ],
            jump: [
                "按空格键可以跳跃！",
                "跳起来！可以躲避地面攻击哦！",
                "哇！跳得真高！"
            ],
            shoot: [
                "左键射击！瞄准那些训练假人！",
                "命中了！你是天生的射手！",
                "连续射击可以造成更多伤害！"
            ],
            skill: [
                "E键释放元素战技！",
                "火元素的力量，燃烧吧！",
                "元素战技有冷却时间，要合理使用哦！"
            ],
            ultimate: [
                "能量满了！按Q键释放大招！",
                "这就是元素爆发的威力！",
                "太厉害了！简直就像真正的英雄！"
            ],
            reaction: [
                "元素反应！这才是战斗的精髓！",
                "蒸发反应能造成2倍伤害！",
                "不同的元素组合有不同的效果哦！"
            ],
            encourage: [
                "加油！你可以的！",
                "别放弃！再试一次！",
                "相信自己！你已经很棒了！"
            ],
            complete: [
                "恭喜完成训练！",
                "你已经是合格的机甲驾驶员了！",
                "太棒了！凯瑟琳一定会很高兴的！"
            ]
        };

        // 初始化游戏
        function initGame() {
            showPaimonDialog(paimonLines.welcome[0]);
            startTutorialStage(0);
            setupEventListeners();
            gameLoop();
        }

        // 显示派蒙对话
        function showPaimonDialog(text) {
            const dialog = document.getElementById('paimonDialog');
            const textElement = document.getElementById('paimonText');
            textElement.textContent = text;
            dialog.classList.add('active');
            
            // 3秒后自动隐藏
            setTimeout(() => {
                dialog.classList.remove('active');
            }, 3000);
        }

        // 开始教学阶段
        function startTutorialStage(stage) {
            if (stage >= gameState.tutorialStages.length) {
                completeTutorial();
                return;
            }

            gameState.currentStage = stage;
            const stageData = gameState.tutorialStages[stage];
            
            // 更新UI
            document.getElementById('missionObjective').textContent = `任务：${stageData.objective}`;
            document.getElementById('tutorialHint').innerHTML = stageData.hint.replace(/(\S+键)/g, '<span class="key-hint">$1</span>');
            
            // 显示阶段标题
            showStageTitle(stageData.name);
            
            // 根据不同阶段初始化
            switch(stage) {
                case 0: // 移动教学
                    showPaimonDialog(paimonLines.movement[0]);
                    break;
                case 1: // 跳跃教学
                    showPaimonDialog(paimonLines.jump[0]);
                    break;
                case 2: // 射击教学
                    showPaimonDialog(paimonLines.shoot[0]);
                    spawnTrainingDummy(70, 80);
                    break;
                case 3: // 元素战技
                    showPaimonDialog(paimonLines.skill[0]);
                    spawnTrainingDummy(30, 80);
                    break;
                case 4: // 元素爆发
                    showPaimonDialog(paimonLines.ultimate[0]);
                    spawnMultipleDummies();
                    break;
                case 5: // 元素反应
                    showPaimonDialog(paimonLines.reaction[0]);
                    createElementZone();
                    break;
                case 6: // 实战测试
                    showPaimonDialog("现在，让我们进行最终测试！");
                    spawnFinalChallenge();
                    break;
            }
            
            // 重置进度
            gameState.tutorialProgress = 0;
            updateProgress(0);
        }

        // 显示阶段标题
        function showStageTitle(title) {
            const titleElement = document.createElement('div');
            titleElement.className = 'stage-title';
            titleElement.textContent = title;
            document.getElementById('gameCanvas').appendChild(titleElement);
            
            setTimeout(() => {
                titleElement.remove();
            }, 3000);
        }

        // 生成训练假人
        function spawnTrainingDummy(x, y) {
            const dummy = document.createElement('div');
            dummy.className = 'training-dummy';
            dummy.style.left = x + '%';
            dummy.style.bottom = '100px';
            dummy.innerHTML = `
                <svg width="60" height="80" viewBox="0 0 60 80">
                    <rect x="10" y="20" width="40" height="50" fill="#8B4513" stroke="#654321" stroke-width="2"/>
                    <circle cx="30" cy="15" r="10" fill="#8B4513" stroke="#654321" stroke-width="2"/>
                    <rect x="25" y="35" width="10" height="10" fill="#FFD700"/>
                    <text x="30" y="75" text-anchor="middle" fill="#FFF" font-size="12">HP: 100</text>
                </svg>
            `;
            dummy.dataset.hp = 100;
            document.getElementById('gameCanvas').appendChild(dummy);
            gameState.enemies.push(dummy);
        }

        // 生成多个假人
        function spawnMultipleDummies() {
            [20, 40, 60, 80].forEach(x => {
                spawnTrainingDummy(x, 80);
            });
        }

        // 创建元素反应区域
        function createElementZone() {
            const zone = document.createElement('div');
            zone.className = 'element-tutorial-zone';
            zone.style.left = '40%';
            zone.style.bottom = '150px';
            zone.innerHTML = '水元素区域';
            zone.dataset.element = 'hydro';
            document.getElementById('gameCanvas').appendChild(zone);
            
            spawnTrainingDummy(50, 80);
        }

        // 最终挑战
        function spawnFinalChallenge() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const x = 20 + Math.random() * 60;
                    spawnTrainingDummy(x, 80);
                }, i * 500);
            }
        }

        // 设置事件监听
        function setupEventListeners() {
            // 键盘控制
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // 鼠标控制
            document.addEventListener('click', handleClick);
            
            // 检测移动设备
            if ('ontouchstart' in window) {
                document.getElementById('mobileControls').style.display = 'flex';
            }
        }

        // 键盘按下事件
        function handleKeyDown(e) {
            const player = document.getElementById('playerMecha');
            
            switch(e.key.toLowerCase()) {
                case 'a':
                case 'arrowleft':
                    movePlayer(-2);
                    checkMovementProgress();
                    break;
                case 'd':
                case 'arrowright':
                    movePlayer(2);
                    checkMovementProgress();
                    break;
                case ' ':
                    e.preventDefault();
                    playerJump();
                    break;
                case 'e':
                    useSkill();
                    break;
                case 'q':
                    useUltimate();
                    break;
            }
        }

        // 键盘松开事件
        function handleKeyUp(e) {
            gameState.isMoving = false;
        }

        // 鼠标点击事件
        function handleClick(e) {
            if (gameState.currentStage >= 2) { // 射击教学开始后才能射击
                playerShoot(e.clientX, e.clientY);
            }
        }

        // 移动玩家
        function movePlayer(direction) {
            gameState.playerX = Math.max(5, Math.min(95, gameState.playerX + direction));
            const player = document.getElementById('playerMecha');
            player.style.left = gameState.playerX + '%';
            gameState.isMoving = true;
        }

        // 玩家跳跃
        function playerJump() {
            const player = document.getElementById('playerMecha');
            if (player.classList.contains('jumping')) return;
            
            player.classList.add('jumping');
            player.style.transition = 'bottom 0.3s ease-out';
            player.style.bottom = '200px';
            
            setTimeout(() => {
                player.style.transition = 'bottom 0.3s ease-in';
                player.style.bottom = '100px';
                setTimeout(() => {
                    player.classList.remove('jumping');
                    player.style.transition = 'left 0.1s ease';
                }, 300);
            }, 300);
            
            // 跳跃教学进度
            if (gameState.currentStage === 1) {
                updateProgress(gameState.tutorialProgress + 25);
                showPaimonDialog(paimonLines.jump[2]);
            }
        }

        // 玩家射击
        function playerShoot(targetX, targetY) {
            if (!gameState.canShoot) return;
            
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.style.left = gameState.playerX + '%';
            bullet.style.bottom = '150px';
            document.getElementById('gameCanvas').appendChild(bullet);
            
            // 计算射击方向
            const rect = document.getElementById('gameCanvas').getBoundingClientRect();
            const startX = (gameState.playerX / 100) * rect.width;
            const startY = rect.height - 150;
            const angle = Math.atan2(targetY - startY, targetX - startX);
            
            // 子弹移动
            let bulletX = gameState.playerX;
            let bulletY = 150;
            const speed = 5;
            
            const bulletInterval = setInterval(() => {
                bulletX += Math.cos(angle) * speed;
                bulletY -= Math.sin(angle) * speed;
                
                bullet.style.left = bulletX + '%';
                bullet.style.bottom = bulletY + 'px';
                
                // 检测碰撞
                checkBulletCollision(bullet, bulletX, bulletY);
                
                // 移除超出屏幕的子弹
                if (bulletX < 0 || bulletX > 100 || bulletY < 0 || bulletY > window.innerHeight) {
                    bullet.remove();
                    clearInterval(bulletInterval);
                }
            }, 16);
            
            // 射击冷却
            gameState.canShoot = false;
            setTimeout(() => {
                gameState.canShoot = true;
            }, 200);
        }

        // 检测子弹碰撞
        function checkBulletCollision(bullet, x, y) {
            gameState.enemies.forEach(enemy => {
                const enemyRect = enemy.getBoundingClientRect();
                const bulletRect = bullet.getBoundingClientRect();
                
                if (bulletRect.left < enemyRect.right &&
                    bulletRect.right > enemyRect.left &&
                    bulletRect.top < enemyRect.bottom &&
                    bulletRect.bottom > enemyRect.top) {
                    
                    // 击中敌人
                    bullet.remove();
                    damageEnemy(enemy, 20);
                    showDamageNumber(enemy, 20, 'normal');
                    
                    // 射击教学进度
                    if (gameState.currentStage === 2) {
                        updateProgress(gameState.tutorialProgress + 20);
                        if (gameState.tutorialProgress >= 100) {
                            showPaimonDialog(paimonLines.shoot[1]);
                        }
                    }
                }
            });
        }

        // 使用技能
        function useSkill() {
            const skillIcon = document.getElementById('skillE');
            if (skillIcon.classList.contains('on-cooldown')) return;
            
            // 创建火元素效果
            createElementEffect(gameState.playerX, 150, 'fire');
            
            // 范围伤害
            gameState.enemies.forEach(enemy => {
                const enemyX = parseFloat(enemy.style.left);
                if (Math.abs(enemyX - gameState.playerX) < 20) {
                    damageEnemy(enemy, 50);
                    showDamageNumber(enemy, 50, 'elemental');
                }
            });
            
            // 技能冷却
            skillIcon.classList.add('on-cooldown');
            skillIcon.dataset.cooldown = '6';
            let cooldown = 6;
            
            const cooldownInterval = setInterval(() => {
                cooldown--;
                skillIcon.dataset.cooldown = cooldown;
                if (cooldown <= 0) {
                    skillIcon.classList.remove('on-cooldown');
                    clearInterval(cooldownInterval);
                }
            }, 1000);
            
            // 元素战技教学进度
            if (gameState.currentStage === 3) {
                updateProgress(100);
                showPaimonDialog(paimonLines.skill[1]);
            }
        }

        // 使用大招
        function useUltimate() {
            const skillIcon = document.getElementById('skillQ');
            if (skillIcon.classList.contains('on-cooldown')) return;
            
            // 全屏火焰效果
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const x = 20 + i * 15;
                    createElementEffect(x, 200, 'fire');
                    
                    // 伤害所有敌人
                    gameState.enemies.forEach(enemy => {
                        damageEnemy(enemy, 100);
                        showDamageNumber(enemy, 100, 'critical');
                    });
                }, i * 100);
            }
            
            // 大招冷却
            skillIcon.classList.add('on-cooldown');
            skillIcon.dataset.cooldown = '20';
            let cooldown = 20;
            
            const cooldownInterval = setInterval(() => {
                cooldown--;
                skillIcon.dataset.cooldown = cooldown;
                if (cooldown <= 0) {
                    skillIcon.classList.remove('on-cooldown');
                    clearInterval(cooldownInterval);
                }
            }, 1000);
            
            // 元素爆发教学进度
            if (gameState.currentStage === 4) {
                updateProgress(100);
                showPaimonDialog(paimonLines.ultimate[1]);
            }
        }

        // 创建元素效果
        function createElementEffect(x, y, element) {
            const effect = document.createElement('div');
            effect.className = 'element-effect';
            effect.style.left = x + '%';
            effect.style.bottom = y + 'px';
            
            const colors = {
                fire: 'radial-gradient(circle, #FF6347, #FF4500, transparent)',
                water: 'radial-gradient(circle, #00CED1, #4682B4, transparent)',
                electro: 'radial-gradient(circle, #9B59B6, #8A2BE2, transparent)'
            };
            
            effect.style.background = colors[element] || colors.fire;
            document.getElementById('gameCanvas').appendChild(effect);
            
            setTimeout(() => {
                effect.remove();
            }, 500);
        }

        // 伤害敌人
        function damageEnemy(enemy, damage) {
            let hp = parseInt(enemy.dataset.hp) || 100;
            hp = Math.max(0, hp - damage);
            enemy.dataset.hp = hp;
            
            // 更新血条显示
            const hpText = enemy.querySelector('text');
            if (hpText) {
                hpText.textContent = `HP: ${hp}`;
            }
            
            // 敌人死亡
            if (hp <= 0) {
                enemy.style.transition = 'opacity 0.5s';
                enemy.style.opacity = '0';
                setTimeout(() => {
                    enemy.remove();
                    const index = gameState.enemies.indexOf(enemy);
                    if (index > -1) {
                        gameState.enemies.splice(index, 1);
                    }
                    
                    // 检查是否完成当前阶段
                    checkStageCompletion();
                }, 500);
            }
        }

        // 显示伤害数字
        function showDamageNumber(target, damage, type) {
            const number = document.createElement('div');
            number.className = `damage-number damage-${type}`;
            number.textContent = damage;
            
            const rect = target.getBoundingClientRect();
            const canvasRect = document.getElementById('gameCanvas').getBoundingClientRect();
            
            number.style.left = (rect.left - canvasRect.left + rect.width / 2) + 'px';
            number.style.top = (rect.top - canvasRect.top) + 'px';
            
            document.getElementById('gameCanvas').appendChild(number);
            
            setTimeout(() => {
                number.remove();
            }, 1000);
        }

        // 检查移动进度
        function checkMovementProgress() {
            if (gameState.currentStage === 0) {
                updateProgress(Math.min(100, gameState.tutorialProgress + 5));
                if (gameState.tutorialProgress >= 50 && gameState.tutorialProgress < 55) {
                    showPaimonDialog(paimonLines.movement[1]);
                }
            }
        }

        // 检查阶段完成
        function checkStageCompletion() {
            if (gameState.currentStage === 6 && gameState.enemies.length === 0) {
                // 最终测试完成
                updateProgress(100);
                showPaimonDialog(paimonLines.complete[0]);
                setTimeout(() => {
                    showAchievement("训练完成！", "你已经掌握了所有基础技能！");
                }, 1000);
            } else if (gameState.enemies.length === 0 && gameState.currentStage >= 2) {
                // 其他战斗阶段完成
                updateProgress(100);
            }
        }

        // 更新进度
        function updateProgress(progress) {
            gameState.tutorialProgress = Math.min(100, progress);
            document.getElementById('progressFill').style.width = gameState.tutorialProgress + '%';
            
            // 进度满时进入下一阶段
            if (gameState.tutorialProgress >= 100) {
                setTimeout(() => {
                    startTutorialStage(gameState.currentStage + 1);
                }, 1500);
            }
        }

        // 显示成就
        function showAchievement(title, description) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.innerHTML = `
                <h2>🏆 ${title}</h2>
                <p>${description}</p>
            `;
            document.body.appendChild(achievement);
            
            setTimeout(() => {
                achievement.style.animation = 'achievementPop 0.5s ease-out reverse';
                setTimeout(() => {
                    achievement.remove();
                }, 500);
            }, 3000);
        }

        // 完成教程
        function completeTutorial() {
            showPaimonDialog("恭喜你完成了所有训练！凯瑟琳会为你感到骄傲的！");
            setTimeout(() => {
                showAchievement("新手毕业", "获得称号：见习机甲驾驶员");
                
                // 显示返回主菜单按钮
                const returnBtn = document.createElement('button');
                returnBtn.textContent = '返回主菜单';
                returnBtn.style.cssText = `
                    position: absolute;
                    bottom: 50px;
                    left: 50%;
                    transform: translateX(-50%);
                    padding: 15px 30px;
                    font-size: 18px;
                    background: linear-gradient(135deg, #9B59B6, #00CED1);
                    border: none;
                    border-radius: 10px;
                    color: white;
                    cursor: pointer;
                    z-index: 200;
                `;
                returnBtn.onclick = () => {
                    window.location.href = 'index.html';
                };
                document.body.appendChild(returnBtn);
            }, 4000);
        }

        // 移动端控制函数
        function moveLeft() {
            movePlayer(-2);
            checkMovementProgress();
        }

        function moveRight() {
            movePlayer(2);
            checkMovementProgress();
        }

        function jump() {
            playerJump();
        }

        function shoot() {
            const rect = document.getElementById('gameCanvas').getBoundingClientRect();
            playerShoot(rect.width / 2, rect.height / 2);
        }

        // 游戏主循环
        function gameLoop() {
            // 更新游戏状态
            
            requestAnimationFrame(gameLoop);
        }

        // 启动游戏
        window.addEventListener('load', () => {
            initGame();
        });
    </script>
</body>
</html>