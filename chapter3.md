# 第三章 - 战斗系统与伤害计算

## 章节大纲

### 3.1 基础伤害公式体系
- 3.1.1 伤害计算核心公式
- 3.1.2 攻击力系统详解
- 3.1.3 技能倍率机制
- 3.1.4 伤害加成类型与叠加规则

### 3.2 防御减免计算
- 3.2.1 防御力减伤公式
- 3.2.2 减防机制与上限
- 3.2.3 抗性系统详解
- 3.2.4 护盾吸收机制

### 3.3 元素反应倍率系统
- 3.3.1 增幅反应（蒸发/融化）
- 3.3.2 剧变反应（超载/感电/超导）
- 3.3.3 特殊反应（冻结/扩散/结晶）
- 3.3.4 元素精通加成计算

### 3.4 充能机制
- 3.4.1 元素能量系统
- 3.4.2 元素微粒与晶球
- 3.4.3 充能效率计算
- 3.4.4 能量循环优化

### 3.5 暴击系统
- 3.5.1 暴击率与暴击伤害
- 3.5.2 暴击收益曲线
- 3.5.3 暴击动画与特效
- 3.5.4 暴击流派构建

### 3.6 连击与combo系统
- 3.6.1 连击计数机制
- 3.6.2 连击伤害加成
- 3.6.3 连击中断条件
- 3.6.4 连击奖励系统

### 3.7 buff与debuff机制
- 3.7.1 增益效果分类
- 3.7.2 减益效果类型
- 3.7.3 效果叠加规则
- 3.7.4 状态优先级

### 3.8 战斗AI系统
- 3.8.1 敌人AI行为树
- 3.8.2 仇恨值机制
- 3.8.3 技能释放逻辑
- 3.8.4 协同作战AI

---

## 3.1 基础伤害公式体系

### 3.1.1 伤害计算核心公式

#### 完整伤害计算流程

**第一步：基础伤害计算**
```
基础伤害 = (角色攻击力 + 武器攻击力 + 圣遗物攻击力) × 技能倍率％
```

**第二步：伤害加成计算**
```
增幅后伤害 = 基础伤害 × (1 + 全伤害加成％ + 元素伤害加成％ + 普攻/重击/技能伤害加成％)
```

**第三步：暴击判定**
```
if (随机数 < 暴击率) {
    暴击伤害 = 增幅后伤害 × (1 + 暴击伤害％)
} else {
    暴击伤害 = 增幅后伤害
}
```

**第四步：防御减免**
```
防御减免后伤害 = 暴击伤害 × 防御减免系数
防御减免系数 = (角色等级 + 100) / [(角色等级 + 100) + (怪物防御 × (1 - 减防％))]
```

**第五步：抗性减免**
```
抗性减免后伤害 = 防御减免后伤害 × 抗性减免系数
抗性减免系数计算:
- 抗性 < 0: 1 - (抗性/2)
- 0 ≤ 抗性 < 75%: 1 - 抗性
- 抗性 ≥ 75%: 1 / (1 + 4×抗性)
```

**第六步：元素反应加成**
```
最终伤害 = 抗性减免后伤害 × 元素反应倍率
```

#### 伤害浮动机制
- **浮动范围**：±5%随机浮动
- **距离衰减**：超过最佳射程后每100像素递减2%伤害
- **连击加成**：每10连击增加1%伤害，上限50%

### 3.1.2 攻击力系统详解

#### 攻击力来源

**基础攻击力（白值）**
- **角色基础攻击**：1级时89-106，90级时298-335
- **武器基础攻击**：
  - 3星武器：38-401
  - 4星武器：42-510  
  - 5星武器：44-608

**额外攻击力（绿值）**
- **固定数值加成**：圣遗物羽毛主属性（311）、副属性（14-19每条）
- **百分比加成**：圣遗物沙漏主属性（46.6%）、副属性（4.1%-5.8%每条）
- **武器副属性**：攻击力％（10.8%-49.6%）
- **角色天赋**：突破加成、被动天赋

#### 攻击力计算示例
```
胡桃90级配置：
基础攻击 = 角色白值(106) + 护摩之杖(608) = 714
圣遗物攻击％ = 时之沙(46.6%) + 副词条(15%) = 61.6%
圣遗物固定攻击 = 羽毛(311) + 副词条(50) = 361

总攻击力 = 714 × (1 + 0.616) + 361 = 1515
```

### 3.1.3 技能倍率机制

#### 技能倍率分类

**普通攻击倍率**
- 1级：50%-80%每段
- 10级：90%-150%每段
- 连击段数：3-6段循环

**元素战技（E技能）倍率**
- 1级：100%-300%
- 10级：180%-540%
- 冷却时间：6-15秒

**元素爆发（Q技能）倍率**
- 1级：200%-800%
- 10级：360%-1440%
- 能量需求：40-90点

#### 倍率成长公式
```
当前等级倍率 = 1级倍率 × [1 + (技能等级-1) × 成长系数]
成长系数 = 0.06-0.08（根据技能类型）
```

### 3.1.4 伤害加成类型与叠加规则

#### 加成类型分类

**独立乘区**
1. **攻击力乘区**：基础攻击 × (1 + 攻击力％总和)
2. **伤害加成乘区**：包含以下子类（加法叠加）
   - 元素伤害加成（杯子主属性46.6%）
   - 物理伤害加成（杯子主属性58.3%）
   - 普攻/重击/元素战技/元素爆发伤害加成
   - 全伤害加成（较少见）
3. **暴击乘区**：1 + 暴击伤害％（暴击时生效）
4. **元素反应乘区**：蒸发2.0x/融化1.5x等
5. **防御乘区**：防御减免系数
6. **抗性乘区**：抗性减免系数

#### 叠加规则
- **同类加法**：相同乘区内的加成相加
- **不同类乘法**：不同乘区之间相乘
- **快照机制**：部分技能释放时锁定当时属性

## 3.2 防御减免计算

### 3.2.1 防御力减伤公式

#### 标准防御公式
```
防御减免 = (角色等级 + 100) / [(角色等级 + 100) + (敌人防御 × (1 - 减防％) × (1 - 无视防御％))]
```

#### 等级压制机制
- **同等级**：标准防御减免
- **高20级**：额外5%伤害加成
- **低20级**：额外5%伤害减免
- **等级差上限**：±30级

#### 防御数值参考
**普通敌人防御**
- 1级：50-100
- 50级：300-500
- 90级：500-800

**精英怪物防御**
- 1级：150-200
- 50级：600-800
- 90级：1000-1200

**Boss防御**
- 1级：200-300
- 50级：800-1000
- 90级：1200-1500

### 3.2.2 减防机制与上限

#### 减防技能类型

**百分比减防**
- 钟离护盾：全抗性-20%
- 雷电将军E：防御力-30%
- 可莉2命：防御力-23%
- 减防上限：90%

**固定值减防**
- 部分技能提供固定防御降低
- 计算优先级低于百分比减防
- 可使防御变为负数

#### 减防叠加规则
1. 同类型减防：取最高值
2. 不同类型减防：乘法叠加
3. 减防持续时间：独立计算
4. 减防debuff图标：最多显示5个

### 3.2.3 抗性系统详解

#### 元素抗性机制

**基础抗性设定**
- 普通敌人：10%全元素抗性
- 元素史莱姆：对应元素免疫，其他10%
- 深渊使徒：护盾期间70%全抗
- 部分Boss：特定元素50%抗性

**抗性计算公式**
```javascript
function 计算抗性减免(基础抗性, 减抗值) {
    最终抗性 = 基础抗性 - 减抗值;
    
    if (最终抗性 < 0) {
        // 负抗性增伤
        return 1 - (最终抗性 / 2);
    } else if (最终抗性 < 0.75) {
        // 正常抗性
        return 1 - 最终抗性;
    } else {
        // 高抗性递减
        return 1 / (1 + 4 * 最终抗性);
    }
}
```

#### 减抗手段
- **风套4件**：扩散元素-40%抗性
- **超导反应**：物理抗性-40%，持续12秒
- **钟离盾**：周围敌人全抗性-20%

### 3.2.4 护盾吸收机制

#### 护盾类型

**元素护盾**
- 基础吸收量：角色生命值的10%-30%
- 元素吸收效率：
  - 同元素：250%吸收
  - 克制元素：50%吸收
  - 其他元素：100%吸收

**全元素护盾**
- 钟离玉璋护盾：基础值+生命值％
- 吸收效率：150%全伤害
- 特殊效果：减抗光环

#### 护盾叠加规则
- 不同角色护盾：独立计算
- 同角色护盾：刷新持续时间
- 护盾上限：生命值的200%

## 3.3 元素反应倍率系统

### 3.3.1 增幅反应（蒸发/融化）

#### 蒸发反应机制

**反应倍率**
- **火触发蒸发**（火打水）：2.0倍伤害
- **水触发蒸发**（水打火）：1.5倍伤害

**元素消耗规则**
```
元素消耗量计算：
触发元素消耗 = 1U（标准单位）
被触发元素消耗 = 触发元素 × 反应系数
- 蒸发反应系数：0.5（强反应）或0.625（弱反应）
```

**蒸发反应优化**
- **元素附着顺序**：先挂水后打火获得2倍增幅
- **内置冷却（ICD）**：普攻2.5秒/3次，技能无ICD
- **多段伤害处理**：每段独立判定反应

#### 融化反应机制

**反应倍率**
- **火触发融化**（火打冰）：1.5倍伤害
- **冰触发融化**（冰打火）：2.0倍伤害

**元素残留机制**
- 强元素（2U/4U）可能在反应后残留
- 弱元素（1U）完全消耗
- 残留量 = 原附着量 - 消耗量

#### 增幅反应加成计算

**元素精通加成公式**
```
反应系数 = 2.78 × 元素精通 / (元素精通 + 1400)
最终倍率 = 基础倍率 × (1 + 反应系数 + 反应加成％)

示例（300元素精通）：
反应系数 = 2.78 × 300 / (300 + 1400) = 0.49
蒸发最终倍率 = 2.0 × (1 + 0.49) = 2.98倍
```

**反应加成来源**
- 4件魔女套装：蒸发融化+15%
- 部分角色天赋：额外反应加成
- 深渊祝福：特定反应+20%-50%

### 3.3.2 剧变反应（超载/感电/超导）

#### 超载反应

**基础伤害计算**
```
超载基础伤害 = 等级系数 × 反应基础倍率
90级超载基础 = 2766 × 4 = 11064

元素精通加成：
精通加成％ = 16 × 元素精通 / (元素精通 + 2000)
500精通加成 = 16 × 500 / 2500 = 3.2倍

最终伤害 = 11064 × (1 + 3.2) = 46469
```

**超载特殊效果**
- **范围爆炸**：半径200像素
- **击退效果**：小体型敌人击退300像素
- **破盾效率**：对岩盾3倍伤害
- **自伤风险**：近距离受到20%反伤

#### 感电反应

**持续伤害机制**
```
感电tick伤害 = 等级系数 × 2.4
90级感电 = 2766 × 2.4 = 6638每跳

触发间隔：1秒
持续时间：水电共存期间
伤害类型：雷元素伤害
```

**感电特性**
- **传导效果**：水域中自动传播
- **多目标**：最多影响5个目标
- **打断效果**：每跳造成轻微硬直
- **元素共存**：水雷元素同时存在

#### 超导反应

**减防效果**
```
物理抗性降低：40%
持续时间：12秒
伤害倍率：1.0（冰伤害）
范围：半径150像素
```

**超导运用场景**
- 物理队核心反应
- 优菈最佳辅助反应
- 对高物抗敌人效果显著

### 3.3.3 特殊反应（冻结/扩散/结晶）

#### 冻结反应

**冻结机制**
- **冻结时长**：基础2秒，受元素量影响
- **冻结公式**：时间 = min(4, 2 × √(水量×冰量))
- **碎冰伤害**：重击或钝器攻击触发
- **控制免疫**：Boss免疫冻结

**冻结流派配合**
- 神里绫华+莫娜：永冻流
- 甘雨+温迪：冻结聚怪
- 冰冻延长：部分角色天赋+20%时长

#### 扩散反应

**扩散机制**
```
扩散伤害 = 等级系数 × 1.2 × 精通加成
扩散范围：半径300像素
元素传播：将被扩散元素附着周围敌人
减抗效果：风套4件触发-40%元素抗性
```

**扩散优先级**
1. 火元素（最高优先）
2. 水元素
3. 雷元素
4. 冰元素（最低优先）

**多元素扩散**
- 可同时扩散2种元素
- 触发对应元素反应
- 染色机制：风元素转化

#### 结晶反应

**护盾生成**
```
护盾量 = 等级系数 × 4.44 × (1 + 精通加成)
90级基础 = 2766 × 4.44 = 12281
300精通 = 12281 × 2.5 = 30702护盾量
```

**结晶特性**
- **拾取范围**：100像素
- **持续时间**：15秒
- **护盾类型**：对应元素150%吸收
- **上限数量**：场上最多3个

### 3.3.4 元素精通加成计算

#### 精通收益公式汇总

**增幅反应（蒸发/融化）**
```
加成％ = 2.78 × EM / (EM + 1400)
```

**剧变反应（超载/感电/超导/碎冰）**
```
加成％ = 16 × EM / (EM + 2000)
```

**结晶反应**
```
加成％ = 4.44 × EM / (EM + 1400)
```

#### 元素精通阈值

| 精通值 | 增幅反应加成 | 剧变反应加成 | 推荐适用角色 |
|--------|-------------|-------------|------------|
| 0      | 0%          | 0%          | 纯输出角色 |
| 100    | 18.6%       | 74.2%       | 副C角色 |
| 200    | 33.3%       | 137.8%      | 反应副C |
| 300    | 45.4%       | 192.5%      | 精通辅助 |
| 500    | 63.5%       | 280.0%      | 纳西妲等 |
| 800    | 79.5%       | 371.2%      | 极限精通流 |

## 3.4 充能机制

### 3.4.1 元素能量系统

#### 能量需求分类

**低能量需求（40点）**
- 技能循环快
- 适合主C角色
- 代表：胡桃、宵宫

**中能量需求（60点）**
- 平衡型设计
- 大部分角色
- 代表：神里绫华、甘雨

**高能量需求（80-90点）**
- 强力爆发技能
- 需要充能支持
- 代表：雷电将军、北斗

#### 能量获取途径

1. **普攻产球**：0.5-1点/次（概率性）
2. **E技能产球**：3-5个元素微粒
3. **击杀奖励**：2-4点能量
4. **队友产球**：共享能量机制

### 3.4.2 元素微粒与晶球

#### 微粒/晶球属性

**元素微粒**
```
基础能量：3点（同元素）/ 1点（异元素）/ 2点（无元素）
拾取范围：自动吸收（7秒后）
移动速度：逐渐加速飞向角色
颜色标识：对应元素色彩
```

**元素晶球**
```
基础能量：9点（同元素）/ 3点（异元素）/ 6点（无元素）
生成条件：精英怪物死亡、特定技能
体积：微粒的2倍
优先级：高于微粒
```

#### 能量分配机制

**前台角色获取**
- 100%能量值
- 直接加入能量槽

**后台角色获取**
- 60%能量值
- 延迟0.1秒到账

**特殊机制**
- 雷电将军：为全队充能
- 西风武器：产生无色微粒
- 祭礼武器：重置E技能

### 3.4.3 充能效率计算

#### 充能效率公式
```
实际获取能量 = 基础能量 × 充能效率％

示例（180%充能效率）：
元素微粒 = 3 × 1.8 = 5.4点
元素晶球 = 9 × 1.8 = 16.2点
```

#### 充能效率来源

**装备来源**
- 时之沙主属性：51.8%
- 副词条：4.5%-6.5%每条
- 2件绝缘套装：+20%

**武器副属性**
- 4星武器：30.6%-45.9%
- 5星武器：36.8%-55.1%
- 西风系列：额外产球

**角色天赋**
- 雷电将军：基于充能提供伤害
- 莫娜：充能转化水伤
- 北斗：完美弹反回能

### 3.4.4 能量循环优化

#### 循环计算工具

**单人循环**
```javascript
function 计算充能需求(技能CD, 大招能量, E产球数) {
    每轮产球 = E产球数 × 3; // 元素微粒能量
    循环次数 = Math.ceil(大招能量 / 每轮产球);
    所需时间 = 循环次数 × 技能CD;
    
    理想充能 = 大招能量 / (技能CD内产球 × 3);
    return 理想充能 × 100 + "%";
}
```

**团队循环**
```
总产球 = Σ(各角色E技能产球)
能量分配 = 前台100% + 后台60%×3
循环时长 = 最长技能CD
充能要求 = 能量需求 / 循环获取
```

#### 充能优化策略

**角色搭配**
- 双元素共鸣：产球效率+20%
- 充能辅助：雷电将军、菲谢尔
- 西风武器：额外无色球

**手法优化**
- 前台拾取：最大化能量
- 漏斗充能：集中给核心角色
- E技能时机：产球后切人

**装备配置**
- 充能沙漏：保证循环>输出
- 绝缘4件：充能转伤害
- 充能武器：循环优先

## 3.5 暴击系统

### 3.5.1 暴击率与暴击伤害

#### 暴击基础数值

**初始属性**
- 基础暴击率：5%
- 基础暴击伤害：50%
- 暴击率上限：100%
- 暴击伤害无上限

**属性来源**
```
暴击率来源：
- 武器副属性：22.1%-33.1%（5星）
- 圣遗物主属性：31.1%（头部）
- 圣遗物副属性：2.7%-3.9%每条
- 角色突破：19.2%-38.4%
- 共鸣/buff：15%-20%

暴击伤害来源：
- 武器副属性：44.1%-66.2%（5星）
- 圣遗物主属性：62.2%（头部）
- 圣遗物副属性：5.4%-7.8%每条
- 角色突破：38.4%-88.4%
```

#### 暴击判定机制
```javascript
function 暴击判定(暴击率) {
    // 生成0-100的随机数
    let roll = Math.random() * 100;
    
    if (roll < 暴击率) {
        return true; // 暴击成功
    }
    return false; // 未暴击
}

function 计算暴击伤害(基础伤害, 暴击伤害％) {
    if (暴击判定(暴击率)) {
        return 基础伤害 × (1 + 暴击伤害％ / 100);
    }
    return 基础伤害;
}
```

### 3.5.2 暴击收益曲线

#### 暴击期望值计算
```
暴击期望伤害 = 基础伤害 × [1 + (暴击率 × 暴击伤害)]

示例计算：
70%暴击率，140%暴击伤害
期望值 = 100 × [1 + (0.7 × 1.4)] = 198

50%暴击率，200%暴击伤害
期望值 = 100 × [1 + (0.5 × 2.0)] = 200
```

#### 暴击配比优化

**黄金比例**
- 理想比例：暴击率:暴击伤害 = 1:2
- 实战建议：70%暴击率 + 140%暴击伤害
- 极限配置：100%暴击率 + 200%+暴击伤害

**收益递减分析**
```javascript
function 计算暴击收益(当前暴率, 当前爆伤, 新增类型, 新增值) {
    let 原期望 = 1 + (当前暴率 * 当前爆伤);
    let 新期望;
    
    if (新增类型 === "暴击率") {
        新期望 = 1 + ((当前暴率 + 新增值) * 当前爆伤);
    } else {
        新期望 = 1 + (当前暴率 * (当前爆伤 + 新增值));
    }
    
    return (新期望 - 原期望) / 原期望 * 100 + "%提升";
}
```

### 3.5.3 暴击动画与特效

#### 暴击视觉反馈

**数字表现**
- 普通伤害：白色，标准大小
- 暴击伤害：橙色，1.5倍大小
- 暴击动画：弹跳效果+光晕扩散

**音效设计**
- 普通命中：轻微打击音
- 暴击命中：重音+金属音
- 连续暴击：音调递增

**特效层级**
1. 命中闪光（0.1秒）
2. 数字弹出（0.3秒）
3. 光环扩散（0.5秒）
4. 粒子飞散（0.8秒）

### 3.5.4 暴击流派构建

#### 主流暴击build

**纯暴击流**
```
配装思路：
- 武器：高暴击副属性
- 圣遗物：暴击/爆伤头
- 副词条：全追暴击双爆
- 目标：100%暴率，250%+爆伤
代表角色：甘雨、胡桃
```

**暴击反应流**
```
配装思路：
- 平衡暴击与元素精通
- 暴击率60-70%
- 元素精通200-300
- 利用反应+暴击双重增幅
代表角色：宵宫、迪卢克
```

**速切爆发流**
```
配装思路：
- 高爆伤，中等暴率
- 配合增益确保暴击
- 爆发窗口期输出
代表角色：优菈、雷电将军
```

## 3.6 连击与combo系统

### 3.6.1 连击计数机制

#### 连击判定规则

**触发条件**
- 命中间隔 < 3秒
- 目标存活
- 伤害 > 0

**计数规则**
```javascript
class ComboSystem {
    constructor() {
        this.combo = 0;
        this.lastHitTime = 0;
        this.comboTimeout = 3000; // 3秒
    }
    
    onHit(damage) {
        let currentTime = Date.now();
        
        if (currentTime - this.lastHitTime > this.comboTimeout) {
            this.combo = 0; // 重置连击
        }
        
        if (damage > 0) {
            this.combo++;
            this.lastHitTime = currentTime;
        }
        
        return this.combo;
    }
}
```

#### 连击显示系统

**UI表现**
- 位置：屏幕右侧
- 字体：逐渐放大效果
- 颜色：随连击数变化
  - 1-10：白色
  - 11-30：蓝色
  - 31-50：紫色
  - 51-99：金色
  - 100+：彩虹色

### 3.6.2 连击伤害加成

#### 加成计算公式
```
连击伤害加成 = min(50%, 连击数 × 0.5%)

实际伤害 = 基础伤害 × (1 + 连击伤害加成)

示例：
30连击 = 15%伤害加成
60连击 = 30%伤害加成
100连击 = 50%伤害加成（上限）
```

#### 连击等级奖励

| 连击数 | 等级称号 | 伤害加成 | 额外奖励 |
|--------|---------|---------|---------|
| 10     | 新手    | 5%      | 无 |
| 30     | 熟练    | 15%     | 经验×1.2 |
| 50     | 精通    | 25%     | 掉率×1.5 |
| 100    | 传说    | 50%     | 稀有掉落 |
| 200    | 神话    | 50%     | 成就解锁 |

### 3.6.3 连击中断条件

#### 中断触发
- **超时中断**：3秒无伤害
- **被击中断**：受到重击
- **切换角色**：连击保留50%
- **场景转换**：完全重置

#### 连击保护机制
- **格挡保护**：完美格挡不断连
- **护盾保护**：护盾期间不断连
- **无敌帧**：大招期间连击保护
- **复活续连**：复活后3秒内可续

### 3.6.4 连击奖励系统

#### 结算奖励
```
基础分 = 连击数 × 10
时间加成 = (1 + 速通系数) × 基础分
完美加成 = 无伤 ? 基础分 × 2 : 基础分

总分 = 基础分 + 时间加成 + 完美加成
```

#### 连击成就
- **初露锋芒**：达成10连击
- **势如破竹**：达成50连击
- **天下无双**：达成100连击
- **超越极限**：达成200连击
- **连击之神**：达成500连击

## 3.7 buff与debuff机制

### 3.7.1 增益效果分类

#### 属性增益

**攻击类增益**
- 攻击力提升：+20%-100%
- 攻速提升：+15%-50%
- 暴击率提升：+10%-30%
- 暴击伤害提升：+20%-60%

**防御类增益**
- 防御力提升：+20%-50%
- 抗性提升：+15%-30%
- 护盾强效：+20%-35%
- 治疗加成：+15%-25%

**元素类增益**
- 元素伤害提升：+15%-35%
- 元素精通提升：+50-200
- 元素充能效率：+20%-45%
- 反应伤害加成：+20%-40%

#### 特殊增益

**机制类**
- 霸体状态：免疫击退
- 元素附魔：普攻转元素
- 冷却缩减：-10%-20%
- 移速提升：+10%-30%

### 3.7.2 减益效果类型

#### 属性削弱

**输出削弱**
- 攻击力降低：-20%-50%
- 攻速降低：-15%-30%
- 元素抗性降低：-20%-40%

**防御削弱**
- 防御力降低：-20%-40%
- 易伤状态：+15%-30%受伤
- 破甲效果：无视20%-50%防御

#### 控制效果

**硬控制**
- 冻结：2-4秒无法行动
- 石化：1-3秒无法行动
- 眩晕：0.5-2秒无法行动

**软控制**
- 减速：-30%-70%移速
- 沉默：无法释放技能
- 缴械：无法普攻

### 3.7.3 效果叠加规则

#### 叠加类型

**覆盖叠加**
- 同类效果取最高值
- 持续时间独立计算
- 示例：两个攻击力buff取高

**累加叠加**
- 数值直接相加
- 有叠加上限
- 示例：护盾值累加

**独立叠加**
- 各自独立生效
- 分别计算效果
- 示例：不同来源减防

#### 叠加公式
```javascript
function 计算最终属性(基础值, buff数组, debuff数组) {
    let 增益总和 = 0;
    let 减益总和 = 0;
    
    // 处理增益
    for (let buff of buff数组) {
        if (buff.类型 === "累加") {
            增益总和 += buff.数值;
        } else if (buff.类型 === "覆盖") {
            增益总和 = Math.max(增益总和, buff.数值);
        }
    }
    
    // 处理减益
    for (let debuff of debuff数组) {
        减益总和 += debuff.数值;
    }
    
    return 基础值 × (1 + 增益总和 - 减益总和);
}
```

### 3.7.4 状态优先级

#### 优先级规则

**控制优先级**
1. 石化（最高）
2. 冻结
3. 眩晕
4. 击飞
5. 减速（最低）

**buff优先级**
1. 无敌/免伤
2. 霸体
3. 护盾
4. 增益效果
5. 普通状态

#### 状态互斥
- 冻结免疫击退
- 霸体免疫控制
- 护盾阻挡debuff
- 净化移除负面

## 3.8 战斗AI系统

### 3.8.1 敌人AI行为树

#### 行为树结构

```javascript
class EnemyAI {
    constructor(type) {
        this.行为树 = {
            根节点: {
                类型: "选择器",
                子节点: [
                    this.生存节点(),
                    this.攻击节点(),
                    this.巡逻节点()
                ]
            }
        };
    }
    
    生存节点() {
        return {
            类型: "序列器",
            条件: () => this.hp < 0.3,
            行为: [
                "寻找掩护",
                "使用治疗",
                "召唤支援"
            ]
        };
    }
    
    攻击节点() {
        return {
            类型: "序列器",
            条件: () => this.检测到敌人(),
            行为: [
                "瞄准目标",
                "选择技能",
                "执行攻击"
            ]
        };
    }
}
```

#### AI难度等级

**简单AI**
- 反应时间：1-2秒
- 技能使用：随机
- 躲避率：20%
- 配合度：0%

**普通AI**
- 反应时间：0.5-1秒
- 技能使用：条件触发
- 躲避率：40%
- 配合度：30%

**困难AI**
- 反应时间：0.2-0.5秒
- 技能使用：优化combo
- 躲避率：60%
- 配合度：70%

**噩梦AI**
- 反应时间：0.1秒
- 技能使用：完美循环
- 躲避率：80%
- 配合度：95%

### 3.8.2 仇恨值机制

#### 仇恨计算
```
仇恨值 = 造成伤害 × 仇恨系数 + 技能仇恨 + 距离修正

仇恨系数：
- 主C：1.5
- 副C：1.2
- 辅助：0.8
- 奶妈：0.6

技能仇恨：
- 普攻：+10
- E技能：+30
- Q技能：+50
- 嘲讽：+500
```

#### 仇恨转移
- **嘲讽技能**：强制转移
- **高伤害**：超过30%血量
- **治疗行为**：+20仇恨/秒
- **仇恨衰减**：-5/秒

### 3.8.3 技能释放逻辑

#### 技能决策树
```javascript
function 选择技能(当前状态) {
    // 优先级判断
    if (血量 < 30% && 有治疗技能) {
        return 释放治疗();
    }
    
    if (多个敌人 && 有AOE技能) {
        return 释放AOE();
    }
    
    if (敌人虚弱 && 有爆发技能) {
        return 释放爆发();
    }
    
    if (技能冷却中) {
        return 普通攻击();
    }
    
    return 最优技能();
}
```

#### 技能组合
- **连招系统**：A→B→C固定连招
- **反应链**：元素技能配合
- **时机把握**：预判玩家行动
- **假动作**：迷惑玩家

### 3.8.4 协同作战AI

#### 团队配合

**阵型保持**
- 前排坦克
- 中排输出
- 后排辅助
- 动态调整

**技能协同**
```javascript
class 团队AI {
    协同攻击(目标) {
        // 坦克先手控制
        坦克.使用控制技能(目标);
        
        // 等待0.5秒
        setTimeout(() => {
            // 输出集火
            所有DPS.集火(目标);
        }, 500);
        
        // 辅助增益
        辅助.释放增益(团队);
    }
}
```

**战术执行**
- **集火战术**：优先击杀
- **分散战术**：避免AOE
- **保护战术**：护卫关键单位
- **撤退战术**：有序撤退

## 本章小结

本章详细阐述了《机甲崩坏：变异纪元》的核心战斗系统与伤害计算机制。通过精确的数值公式和丰富的战斗机制，确保游戏战斗体验既有深度又不失平衡性。

关键要点：
1. **伤害计算**采用多层乘区设计，提供丰富的build构建空间
2. **元素反应**系统继承原神精髓，同时加入机甲特色
3. **暴击系统**提供稳定收益曲线，避免过度随机
4. **连击机制**鼓励连续作战，提升操作上限
5. **AI系统**提供多样化挑战，确保PVE内容可玩性

所有数值均经过精心设计与平衡，确保不同流派都有其独特优势，为玩家提供多样化的游戏体验。

---

*第三章完*
